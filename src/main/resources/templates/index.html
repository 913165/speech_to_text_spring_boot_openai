<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to Text - Spring AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

                 .container {
             background: rgba(255, 255, 255, 0.95);
             backdrop-filter: blur(10px);
             border-radius: 20px;
             padding: 40px;
             box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
             max-width: 1200px;
             width: 95%;
             text-align: center;
         }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }

                 .main-content {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 40px;
             margin: 40px 0;
             align-items: start;
         }
         
         .upload-section {
             margin: 0;
         }

        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 40px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f0ff;
            transform: scale(1.02);
        }

        .upload-area.has-file {
            border-color: #28a745;
            background: #f0fff4;
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #999;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 1;
        }

        .file-info {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .file-info.show {
            display: block;
        }

        .file-details {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .file-icon {
            font-size: 2em;
        }

        .file-meta {
            text-align: left;
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666;
            font-size: 14px;
        }

                 .video-preview {
             margin-top: 15px;
             border-radius: 8px;
             overflow: hidden;
             max-width: 100%;
             max-height: 300px;
         }

                 .video-preview video {
             width: 100%;
             max-height: 250px;
             object-fit: cover;
             border-radius: 8px;
         }

        .process-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .process-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #218838, #1e7e34);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .process-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .process-button.processing {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .status {
            margin: 20px 0;
            font-size: 18px;
            font-weight: 500;
            min-height: 25px;
        }

        .status.idle { color: #666; }
        .status.processing { color: #ffc107; }
        .status.complete { color: #28a745; }
        .status.error { color: #dc3545; }

                 .transcript-container {
             margin-top: 0;
             height: 100%;
             display: flex;
             flex-direction: column;
         }

                 .transcript {
             background: #f8f9fa;
             border: 2px solid #e9ecef;
             border-radius: 15px;
             padding: 20px;
             min-height: 400px;
             font-size: 16px;
             line-height: 1.6;
             text-align: left;
             color: #333;
             white-space: pre-wrap;
             word-wrap: break-word;
             flex: 1;
             overflow-y: auto;
         }

        .transcript.empty {
            color: #999;
            font-style: italic;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-clear {
            background: #6c757d;
            color: white;
        }

        .btn-clear:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-copy {
            background: #17a2b8;
            color: white;
        }

        .btn-copy:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }

        .btn-remove:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .error-message {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #c53030;
            display: none;
        }

                 @media (max-width: 768px) {
             .main-content {
                 grid-template-columns: 1fr;
                 gap: 20px;
             }
             
             .container {
                 padding: 30px 20px;
                 max-width: 100%;
                 width: 100%;
             }
             
             h1 {
                 font-size: 2em;
             }
             
             .upload-area {
                 padding: 30px 20px;
                 min-height: 160px;
             }
             
             .upload-icon {
                 font-size: 3em;
             }
             
             .transcript {
                 min-height: 300px;
             }
         }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 Video to Text - Spring AI</h1>
        
                 <div class="main-content">
             <div class="upload-section">
                 <div class="upload-area" id="uploadArea">
                     <div class="upload-icon">📹</div>
                     <div class="upload-text">Drop your MP4 file here</div>
                     <div class="upload-subtext">or click to browse</div>
                     <input type="file" class="file-input" id="fileInput" accept=".mp4,video/mp4,.mp3,audio/mp3,.wav,audio/wav">
                 </div>
                 
                 <div class="file-info" id="fileInfo">
                     <div class="file-details">
                         <div class="file-icon">🎥</div>
                         <div class="file-meta">
                             <div class="file-name" id="fileName"></div>
                             <div class="file-size" id="fileSize"></div>
                         </div>
                     </div>
                     <div class="video-preview" id="videoPreview"></div>
                     <button class="process-button" id="processBtn">
                         Extract Audio & Convert to Text
                     </button>
                 </div>
                 
                 <div class="progress-container" id="progressContainer">
                     <div class="progress-bar">
                         <div class="progress-fill" id="progressFill"></div>
                     </div>
                     <div class="progress-text" id="progressText">Processing...</div>
                 </div>
                 
                 <div class="status idle" id="status">Select an MP4 file to get started</div>
                 
                 <div class="controls">
                     <button class="btn btn-remove" id="removeBtn" disabled>Remove File</button>
                     <button class="btn btn-clear" id="clearBtn" disabled>Clear Text</button>
                     <button class="btn btn-copy" id="copyBtn" disabled>Copy Text</button>
                 </div>
             </div>
             
             <div class="transcript-container">
                 <h3 style="margin-bottom: 15px; color: #333; text-align: left;">📝 Transcription Results</h3>
                 <div class="transcript empty" id="transcript">
                     Transcribed text will appear here...
                 </div>
             </div>
         </div>
        
        <div class="error-message" id="errorMessage"></div>
    </div>

    <script th:inline="javascript">
        class VideoToTextUI {
            constructor() {
                this.currentFile = null;
                this.transcript = '';
                this.isProcessing = false;
                this.isFileSelectionInProgress = false;
                
                this.uploadArea = document.getElementById('uploadArea');
                this.fileInput = document.getElementById('fileInput');
                this.fileInfo = document.getElementById('fileInfo');
                this.fileName = document.getElementById('fileName');
                this.fileSize = document.getElementById('fileSize');
                this.videoPreview = document.getElementById('videoPreview');
                this.processBtn = document.getElementById('processBtn');
                this.progressContainer = document.getElementById('progressContainer');
                this.progressFill = document.getElementById('progressFill');
                this.progressText = document.getElementById('progressText');
                this.status = document.getElementById('status');
                this.transcriptDiv = document.getElementById('transcript');
                this.removeBtn = document.getElementById('removeBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.copyBtn = document.getElementById('copyBtn');
                this.errorMessage = document.getElementById('errorMessage');
                
                this.initializeEventListeners();
            }
            
            initializeEventListeners() {
                // File upload events - prevent double triggering
                this.uploadArea.addEventListener('click', (e) => {
                    // Only trigger if clicking on the upload area or its direct children
                    if (e.target === this.uploadArea || 
                        e.target.classList.contains('upload-icon') || 
                        e.target.classList.contains('upload-text') || 
                        e.target.classList.contains('upload-subtext')) {
                        
                        if (!this.isFileSelectionInProgress) {
                            this.isFileSelectionInProgress = true;
                            this.fileInput.click();
                        }
                    }
                });
                
                // Direct file input click as fallback
                this.fileInput.addEventListener('click', (e) => {
                    if (!this.isFileSelectionInProgress) {
                        this.isFileSelectionInProgress = true;
                    }
                });
                
                this.fileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files[0]);
                });
                
                // Drag and drop events
                this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));
                
                // Button events
                this.processBtn.addEventListener('click', () => this.processVideo());
                this.removeBtn.addEventListener('click', () => this.removeFile());
                this.clearBtn.addEventListener('click', () => this.clearTranscript());
                this.copyBtn.addEventListener('click', () => this.copyToClipboard());
                
                // Prevent default drag behaviors on document
                document.addEventListener('dragover', (e) => e.preventDefault());
                document.addEventListener('drop', (e) => e.preventDefault());
            }
            
            handleDragOver(e) {
                e.preventDefault();
                this.uploadArea.classList.add('dragover');
            }
            
            handleDragLeave(e) {
                e.preventDefault();
                this.uploadArea.classList.remove('dragover');
            }
            
            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                this.uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && !this.isFileSelectionInProgress) {
                    this.isFileSelectionInProgress = true;
                    this.handleFileSelect(files[0]);
                }
            }
            
            handleFileSelect(file) {
                if (!file) {
                    this.isFileSelectionInProgress = false;
                    return;
                }
                
                // Check for supported file types
                const supportedTypes = ['video/mp4', 'audio/mp3', 'audio/wav', 'audio/mp4'];
                if (!supportedTypes.includes(file.type)) {
                    this.showError('Please select a supported file type (MP4, MP3, WAV).');
                    this.isFileSelectionInProgress = false;
                    return;
                }
                
                if (file.size > 500 * 1024 * 1024) { // 500MB limit
                    this.showError('File size must be less than 500MB.');
                    this.isFileSelectionInProgress = false;
                    return;
                }
                
                this.currentFile = file;
                this.displayFileInfo();
                this.hideError();
                this.isFileSelectionInProgress = false;
            }
            
            displayFileInfo() {
                this.fileName.textContent = this.currentFile.name;
                this.fileSize.textContent = this.formatFileSize(this.currentFile.size);
                
                // Show video preview for video files
                if (this.currentFile.type.startsWith('video/')) {
                    const videoURL = URL.createObjectURL(this.currentFile);
                    this.videoPreview.innerHTML = `
                        <video controls>
                            <source src="${videoURL}" type="${this.currentFile.type}">
                            Your browser does not support the video tag.
                        </video>
                    `;
                } else {
                    this.videoPreview.innerHTML = `
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">🎵</div>
                            <div>Audio File: ${this.currentFile.name}</div>
                        </div>
                    `;
                }
                
                // Update UI
                this.uploadArea.classList.add('has-file');
                this.fileInfo.classList.add('show');
                this.removeBtn.disabled = false;
                this.status.textContent = 'File ready for processing';
                this.status.className = 'status idle';
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            async processVideo() {
                if (!this.currentFile) {
                    this.showError('Please select a file first.');
                    return;
                }
                
                this.isProcessing = true;
                this.updateProcessingUI();
                
                try {
                    // Create FormData for file upload
                    const formData = new FormData();
                    formData.append('video', this.currentFile);
                    
                    // Send to Spring Boot backend
                    await this.sendToBackend(formData);
                    
                } catch (error) {
                    console.error('Processing error:', error);
                    this.showError('Failed to process file. Please try again.');
                    this.isProcessing = false;
                    this.updateProcessingUI();
                }
            }
            
                         async sendToBackend(formData) {
                 const BACKEND_URL = '/api/video-to-text';
                 
                 // Start simulated progress after a small delay
                 setTimeout(() => {
                     this.startProgressSimulation();
                 }, 500);
                 
                 try {
                     const response = await fetch(BACKEND_URL, {
                         method: 'POST',
                         body: formData
                     });
                     
                     if (!response.ok) {
                         const errorData = await response.json().catch(() => ({}));
                         throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                     }
                     
                     const result = await response.json();
                     this.handleBackendResponse(result);
                     
                 } catch (error) {
                     console.error('Backend error:', error);
                     throw error;
                 } finally {
                     // Stop progress simulation
                     this.stopProgressSimulation();
                 }
             }
            
            handleBackendResponse(result) {
                if (result.success) {
                    this.setTranscript(result.transcript || '');
                    this.completeProcessing();
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }
            }
            
                         updateProcessingUI() {
                 if (this.isProcessing) {
                     this.processBtn.textContent = 'Processing...';
                     this.processBtn.classList.add('processing');
                     this.processBtn.disabled = true;
                     this.status.textContent = 'Processing file with Spring AI...';
                     this.status.className = 'status processing';
                     this.progressContainer.classList.add('show');
                     this.updateProgress(0, 'Starting...');
                     
                     // Stop any existing progress simulation
                     if (this.progressInterval) {
                         clearInterval(this.progressInterval);
                         this.progressInterval = null;
                     }
                 } else {
                     this.processBtn.textContent = 'Extract Audio & Convert to Text';
                     this.processBtn.classList.remove('processing');
                     this.processBtn.disabled = false;
                     this.progressContainer.classList.remove('show');
                     
                     // Stop progress simulation
                     if (this.progressInterval) {
                         clearInterval(this.progressInterval);
                         this.progressInterval = null;
                     }
                 }
             }
            
            updateProgress(percent, message = 'Processing...') {
                this.progressFill.style.width = `${percent}%`;
                this.progressText.textContent = `${message} (${percent}%)`;
            }
            
            completeProcessing() {
                this.isProcessing = false;
                this.updateProcessingUI();
                this.status.textContent = 'Processing complete!';
                this.status.className = 'status complete';
                
                setTimeout(() => {
                    this.status.textContent = 'Ready for another file';
                    this.status.className = 'status idle';
                }, 3000);
            }
            
            removeFile() {
                this.currentFile = null;
                this.fileInput.value = '';
                this.uploadArea.classList.remove('has-file');
                this.fileInfo.classList.remove('show');
                this.videoPreview.innerHTML = '';
                this.removeBtn.disabled = true;
                this.status.textContent = 'Select an MP4 file to get started';
                this.status.className = 'status idle';
                this.hideError();
            }
            
            clearTranscript() {
                this.transcript = '';
                this.updateTranscript();
            }
            
            updateTranscript() {
                if (this.transcript.trim()) {
                    this.transcriptDiv.textContent = this.transcript;
                    this.transcriptDiv.classList.remove('empty');
                    this.clearBtn.disabled = false;
                    this.copyBtn.disabled = false;
                } else {
                    this.transcriptDiv.textContent = 'Transcribed text will appear here...';
                    this.transcriptDiv.classList.add('empty');
                    this.clearBtn.disabled = true;
                    this.copyBtn.disabled = true;
                }
            }
            
            async copyToClipboard() {
                try {
                    await navigator.clipboard.writeText(this.transcript);
                    const originalText = this.copyBtn.textContent;
                    this.copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        this.copyBtn.textContent = originalText;
                    }, 2000);
                } catch (error) {
                    console.error('Failed to copy text:', error);
                    this.showError('Failed to copy text to clipboard');
                }
            }
            
            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                this.status.textContent = 'Error occurred';
                this.status.className = 'status error';
            }
            
            hideError() {
                this.errorMessage.style.display = 'none';
            }
            
            // Public methods for backend integration
            setTranscript(text) {
                this.transcript = text;
                this.updateTranscript();
            }
            
            appendTranscript(text) {
                this.transcript += text;
                this.updateTranscript();
            }
            
            getTranscript() {
                return this.transcript;
            }
            
                         getCurrentFile() {
                 return this.currentFile;
             }
             
             // Progress simulation methods
             startProgressSimulation() {
                 // Calculate progress speed based on file size
                 const fileSize = this.currentFile ? this.currentFile.size : 1024 * 1024; // Default 1MB
                 const baseSpeed = Math.max(200, Math.min(1500, fileSize / (1024 * 1024) * 200)); // 200-1500ms based on file size
                 
                 this.progressInterval = setInterval(() => {
                     const currentProgress = parseInt(this.progressFill.style.width) || 0;
                     if (currentProgress < 90) {
                         // Slower progress for larger files
                         const increment = Math.max(2, Math.min(15, 20 - (fileSize / (1024 * 1024) * 2)));
                         const newProgress = Math.min(currentProgress + increment, 90);
                         this.updateProgress(newProgress, this.getProgressMessage(newProgress));
                     }
                 }, baseSpeed);
             }
             
             stopProgressSimulation() {
                 if (this.progressInterval) {
                     clearInterval(this.progressInterval);
                     this.progressInterval = null;
                 }
                 // Complete the progress to 100%
                 this.updateProgress(100, 'Complete!');
             }
             
             getProgressMessage(progress) {
                 if (progress < 20) return 'Uploading file...';
                 if (progress < 40) return 'Processing audio...';
                 if (progress < 60) return 'Transcribing with AI...';
                 if (progress < 80) return 'Finalizing transcription...';
                 if (progress < 100) return 'Almost done...';
                 return 'Complete!';
             }
         }
        
        // Initialize the video-to-text UI
        const videoUI = new VideoToTextUI();
        
        // Make it globally accessible for backend integration
        window.videoUI = videoUI;
    </script>
</body>
</html> 